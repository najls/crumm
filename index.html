<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Card Randomizer Utility for Midgar Madness</title>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script> <!-- https://github.com/mebjas/html5-qrcode/ -->

    <style>
        :root {
            --gap: .75rem;
            --gill-sans: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        }

        body {
            background-color: black;
            color: white;
            display: flex;
            flex-direction: column;
            font-family: var(--gill-sans);
            margin: 0;
            min-height: 100vh;
        }

        header { padding: var(--gap); }

        main {
            display: flex;
            flex: 1;
            flex-direction: column;
            padding: var(--gap);
        }

        button {
            background-color: lightpink;
            background-image: linear-gradient(to bottom, lightpink, rgb(255, 212, 223), lightpink);
            border: .5rem solid gray;
            border-radius: .5rem;
            border-style: ridge;
            color: black;
            font-size: 1.5rem;
            font-family: var(--gill-sans);
            font-weight: 700;
            padding: .25rem;
            text-transform: uppercase;
        }

        button:disabled {
            background-color: gray;
            background-image: linear-gradient(to bottom, gray, rgb(158, 158, 158), gray);
        }

        #card {
            background-color: #000123;
            background-image: linear-gradient(to bottom right, rgb(1, 0, 175), rgb(0, 1, 35));
            border: var(--gap) solid white;
            border-radius: 1rem;
            border-style: ridge;
            display: flex;
            flex: 1;
            flex-direction: column;
            padding: var(--gap);
        }

        #question {
            align-items: center;
            display: flex;
            flex: 1;
            font-size: 2rem;
            justify-content: center;
            margin: 0;
        }

        #alternatives {
            display: flex;
            flex: 0;
            flex-direction: column;
            font-size: 1.5rem;
            list-style: none;
            margin: 1rem 0;
            padding: 0;
        }

        #alternatives li {
            flex: 1;
            text-align: center;
        }

        #reveal { margin: var(--gap); }

        .display-none { display: none; }
        #answer.revealed::before { content: "[ "; }
        #answer.revealed::after { content: " ]"; }

        body, main, #alternatives { gap: var(--gap); }
    </style>
</head>
<body>
    <main>
        <button id="renderReader" data-open="Read new card" data-close="Close reader">Read new card</button>
        <div class="display-none" id="reader"></div>
        <div id="card">
            <p id="question"></p>
            <ul id="alternatives"></ul>
            <button id="reveal" disabled>Reveal answer</button>
        </div>
    </main>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('clear')) localStorage.clear();

        const config = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            rememberLastUsedCamera: true,
            supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
        };

        const html5QrCode = new Html5Qrcode("reader");
        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
            stopCamera();
            readerContainer.classList.add('display-none');
            renderQuestion(decodedText);
        };

        var readerContainer = document.getElementById('reader');
        document.getElementById('renderReader').addEventListener('click', async function() {
            if (readerContainer.classList.toggle('display-none')) {
                stopCamera();
                this.innerText = this.dataset.open;
            }
            else {
                html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);
                this.innerText = this.dataset.close;
            }
        });

        document.getElementById('reveal').addEventListener('click', function() {
            document.getElementById('answer').classList.add('revealed');
            this.disabled = true;
        });

        function stopCamera() {
            html5QrCode.stop().then((ignore) => {
                html5QrCode.clear();
            })/*.catch((err) => {
                console.log(`Camera stop failed: ${err}`)
            });*/
        }

        async function renderQuestion(url) {
            let question = await loadQuestion(url);
            document.getElementById('question').innerText = question.text;

            let ul = document.getElementById('alternatives');
            while (ul.firstChild) ul.removeChild(ul.firstChild);

            for (let i = 0; i < question.alternatives.length; i++) {
                let li = document.createElement('li');
                let text = document.createTextNode(question.alternatives[i].text);
                li.append(text);
                if (i + 1 == question.answer) li.setAttribute('id', 'answer');
                ul.appendChild(li);
            }

            document.getElementById('reveal').disabled = false;
        }

        async function loadQuestion(url) {
            const response = await fetch(url);
            const json = await response.json();

            if (!localStorage.getItem(url)) {
                localStorage.setItem(url, JSON.stringify({
                    'size': json.questions.length, // number of questions
                    'draw': [...Array(json.questions.length).keys()] // draw card pile
                }));
            }

            return getRandomQuestion(json, url);
        }

        function getRandomQuestion(data, key) {
            let category = JSON.parse(localStorage.getItem(key));

            if (!category.draw.length) category.draw = [...Array(category.size).keys()];

            let i = Math.floor(Math.random() * category.draw.length);
            let n = category.draw[i];

            category.draw.splice(i, 1);
            localStorage.setItem(key, JSON.stringify(category));
            return data.questions[n];
        }
    </script>
</body>
</html>
