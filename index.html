<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Card Randomizer Utility for Midgar Madness</title>

    <!-- https://github.com/mebjas/html5-qrcode/ -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" integrity="sha384-c9d8RFSL+u3exBOJ4Yp3HUJXS4znl9f+z66d1y54ig+ea249SpqR+w1wyvXz/lk+" crossorigin="anonymous"></script>

    <style>
        @font-face {
            font-display: swap; /* Check https://developer.mozilla.org/en-US/docs/Web/CSS/@font-face/font-display for other options. */
            font-family: 'Chakra Petch';
            font-style: normal;
            font-weight: 400;
            src: url('chakra-petch-v11-latin/chakra-petch-v11-latin-regular.woff2') format('woff2'); /* Chrome 36+, Opera 23+, Firefox 39+, Safari 12+, iOS 10+ */
        }

        :root {
            --gap: .75rem;
            --chakra: 'Chakra Petch', sans-serif;
        }

        body {
            background-color: black;
            color: white;
            display: flex;
            flex-direction: column;
            font-family: var(--chakra);
            margin: 0;
            min-height: 100vh;
        }

        header { padding: var(--gap); }
        main {
            display: flex;
            flex: 1;
            flex-direction: column;
            padding: var(--gap);
        }

        button {
            background-color: lightpink;
            background-image: linear-gradient(to bottom, lightpink, rgb(255, 212, 223), lightpink);
            border: .25rem solid gray;
            border-radius: .5rem;
            border-style: ridge;
            color: black;
            font-size: 1.5rem;
            font-family: var(--chakra);
            font-weight: 700;
            padding: .25rem;
            text-transform: uppercase;
        }

        button:disabled {
            background-color: gray;
            background-image: linear-gradient(to bottom, gray, rgb(158, 158, 158), gray);
        }

        #renderReader { margin-top: var(--gap); }
        #card {
            background-color: #000123;
            background-image: linear-gradient(to bottom right, rgb(1, 0, 175), rgb(0, 1, 35));
            border: .25rem solid white;
            border-radius: 1rem;
            border-style: ridge;
            display: flex;
            flex: 1;
            flex-direction: column;
            padding: var(--gap);
            text-shadow: .125rem .125rem black;
        }

        #title {
            font-size: 1.125rem;
            font-weight: normal;
            margin: 0 0 .75rem;
        }

        #card > div {
            display: flex;
            flex: 1;
            flex-direction: column;
        }

        #question {
            font-size: 2rem;
            margin: 0;
        }

        #alternatives {
            font-size: 1.5rem;
            list-style: none;
            margin: 1rem 0;
            padding: 0;
        }

        #alternatives > li {
            line-height: 1.125;
            padding-top: .25rem;
            padding-bottom: .25rem;
            text-align: center;
        }

        #question.long { font-size: 1.75rem; }
        #alternatives.long { font-size: 1.25rem; }
        #answer.revealed::before { content: "[ "; }
        #answer.revealed::after { content: " ]"; }
        .display-none { display: none; }
    </style>
</head>
<body>
    <main>
        <div class="display-none" id="reader"></div>
        <div id="card">
            <h1 class="display-none" id="title"></h1>
            <div>
                <p id="question">All right, everyone, let's mosey.</p>
                <ul id="alternatives"></ul>
            </div>
            <button id="reveal" disabled>Reveal answer</button>
        </div>
        <button id="renderReader" data-open="Read new card" data-close="Close reader">Read new card</button>
    </main>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('clear')) {
            localStorage.clear();
            window.history.replaceState(null, '', window.location.pathname);
            document.getElementById('question').innerText = 'Cleared local storage!';
        }

        var renderReadBtn = document.getElementById('renderReader');

        const config = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            rememberLastUsedCamera: true,
            supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
        };

        const html5QrCode = new Html5Qrcode("reader");
        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
            try { stopCamera(); }
            catch (err) { console.log(err); }
            renderReadBtn.innerText = renderReadBtn.dataset.open;
            readerContainer.classList.add('display-none');
            loadQuestion(decodedText);
        };

        var readerContainer = document.getElementById('reader');
        renderReadBtn.addEventListener('click', async function() {
            if (readerContainer.classList.toggle('display-none')) {
                try { stopCamera(); }
                catch (err) { console.log(err); }
                this.innerText = this.dataset.open;
            }
            else {
                this.disabled = true;
                html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback).then(() => {
                    if (html5QrCode.getState() === 2) {
                        this.innerText = this.dataset.close;
                        this.disabled = false;
                        window.scrollTo(0, 0);
                    }
                })
                .catch((err) => {
                    console.log(err);
                    readerContainer.classList.add('display-none')
                    this.disabled = false;
                });
            }
        });

        document.getElementById('reveal').addEventListener('click', function() {
            document.getElementById('answer').classList.add('revealed');
            this.disabled = true;
        });

        function stopCamera() {
            html5QrCode.stop().then(() => { html5QrCode.clear(); })
            .catch((err) => { console.log(err); });
        }

        async function loadQuestion(url) {
            const response = await fetch(url);
            const collData = await response.json();

            let storageData = JSON.parse(localStorage.getItem(url));

            if (!storageData) {
                localStorage.setItem(url, JSON.stringify({
                    'title': collData.title,
                    'draw': [...Array(collData.questions.length).keys()] // draw card pile
                }));

                storageData = JSON.parse(localStorage.getItem(url));
            }

            let question = getRandomQuestion(collData, url, storageData);
            renderQuestion(question, storageData.title);
        }

        async function renderQuestion(question, title) {
            let titleElem = document.getElementById('title');

            if (title) {
                titleElem.innerText = title;
                titleElem.classList.remove('display-none');
            }
            else { titleElem.classList.add('display-none'); }

            let qnElem = document.getElementById('question');
            qnElem.innerText = question.text;

            if (question.text.length > 100) qnElem.classList.add('long');
            else qnElem.classList.remove('long');

            let ansLen = 0;
            let ansElem = document.getElementById('alternatives');
            while (ansElem.firstChild) ansElem.removeChild(ansElem.firstChild);

            for (let i = 0; i < question.alternatives.length; i++) {
                let li = document.createElement('li');

                let text = document.createTextNode(question.alternatives[i].text);
                li.append(text);
                ansLen += text.length;

                if (i + 1 == question.answer) li.setAttribute('id', 'answer');
                ansElem.appendChild(li);
            }

            if (ansLen > 100) ansElem.classList.add('long');
            else ansElem.classList.remove('long');

            document.getElementById('reveal').disabled = false;
        }

        function getRandomQuestion(collData, key, storageData) {
            if (!storageData.draw.length) {
                storageData.title = collData.title;
                storageData.draw = [...Array(collData.questions.length).keys()];
            }

            let i = Math.floor(Math.random() * storageData.draw.length);
            let n = storageData.draw[i];

            storageData.draw.splice(i, 1);
            localStorage.setItem(key, JSON.stringify(storageData));
            return collData.questions[n];
        }
    </script>
</body>
</html>
