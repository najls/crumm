<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>TP</title>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script> <!-- https://github.com/mebjas/html5-qrcode/ -->

    <style>
        :root {
            --gap: 1rem;
        }

        body {
            background-color: black;
            color: white;
            display: flex;
            flex-direction: column;
            margin: 0;
            min-height: 100vh;
        }

        header { padding: var(--gap); }

        main {
            display: flex;
            flex: 1;
            flex-direction: column;
            padding: var(--gap);
        }

        body, main { gap: var(--gap); }

        #card {
            background-color: blueviolet;
            border: var(--gap) solid white;
            border-radius: 1.5rem;
            flex: 1;
        }

        .inactive { display: none; }
    </style>
</head>
<body>
    <main>
        <div>
            <button id="renderReader">Scan code</button>
            <button id="testButton">Test</button>
            <button id="testButton2">Test 2</button>
        </div>
        <div class="inactive" id="reader"></div>
        <div id="card">
            <p id="question"></p>
        </div>
    </main>
    <script>
        var config = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            rememberLastUsedCamera: true,
            supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
        };

        var html5QrcodeScanner = undefined;
        var readerContainer = document.getElementById('reader');

        var categoryMap = new Map();

        document.getElementById('testButton').addEventListener('click', function() {
            renderQuestion('https://najls.github.io/crumm/test.json');
        });

        document.getElementById('testButton2').addEventListener('click', function() {
            renderQuestion('https://najls.github.io/crumm/sega.json');
        });

        document.getElementById('renderReader').addEventListener('click', async function() {
            readerContainer.classList.toggle('inactive');

            if (readerContainer.classList.contains('inactive')) {
                html5QrcodeScanner.clear();
            }
            else {
                html5QrcodeScanner = new Html5QrcodeScanner("reader", config, false);
                html5QrcodeScanner.render(onScanSuccess, onScanFailure);
            }
        });

        function onScanSuccess(decodedText, decodedResult) {
            html5QrcodeScanner.clear();
            readerContainer.classList.add('inactive');
            renderQuestion(decodedText);
        }

        function onScanFailure(error) {
            // handle scan failure, usually better to ignore and keep scanning.
        }

        async function renderQuestion(url) {
            let obj = await loadQuestion(url);
            console.log(obj)
            document.getElementById('question').innerHTML = obj.question;
        }

        async function loadQuestion(url) {
            const response = await fetch(url);
            const json = await response.json();

            if (!categoryMap.has(url)) {
                categoryMap.set(url, {
                    'length': json.questions.length,
                    'draw': [...Array(json.questions.length).keys()]
                });
            }

            return getRandomQuestion(json, url);
        }

        function getRandomQuestion(data, key) {
            let c = categoryMap.get(key);

            if (!c.draw.length) c.draw = [...Array(data.questions.length).keys()];

            let i = Math.floor(Math.random() * c.draw.length);
            let n = c.draw[i];

            c.draw.splice(i, 1);
            return data.questions[n];
        }
    </script>
</body>
</html>
